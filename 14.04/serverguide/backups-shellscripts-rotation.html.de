<!DOCTYPE html>
<html lang=de>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Archiv-Rotation</title>
<link rel="stylesheet" type="text/css" href="de.css">
<script type="text/javascript" src="jquery.js"></script><script type="text/javascript" src="jquery.syntax.js"></script><script type="text/javascript" src="yelp.js"></script>
</head>
<body id="home">
<script src="https://ssl.google-analytics.com/urchin.js" type="text/javascript"></script><script type="text/javascript">
        _uacct = "UA-1018242-8";
        urchinTracker();
      </script><div id="container">
<div id="container-inner">
<div id="mothership"><ul>
<li><a href="https://partners.ubuntu.com">Partners</a></li>
<li><a href="https://www.ubuntu.com/support/community-support">Support</a></li>
<li><a href="https://community.ubuntu.com">Community</a></li>
<li><a href="https://www.ubuntu.com">Ubuntu.com</a></li>
</ul></div>
<div id="header">
<h1 id="ubuntu-header"><a href="https://help.ubuntu.com/">Ubuntu Documentation</a></h1>
<ul id="main-menu">
<li><a class="main-menu-item current" href="../../">Official Documentation</a></li>
<li><a href="https://help.ubuntu.com/community/CommunityHelpWiki">Community Help Wiki</a></li>
<li><a href="https://community.ubuntu.com/t/contribute/26">Contribute</a></li>
</ul>
</div>
<div id="menu-search"><div id="search-box">
<noscript><form action="https://www.google.com/cse" id="cse-search-box"><div>
<input type="hidden" name="cx" value="003883529982892832976:e2vwumte3fq"><input type="hidden" name="ie" value="UTF-8"><input type="text" name="q" size="21"><input type="submit" name="sa" value="Search">
</div></form></noscript>
<script>
                document.write('<form action="../../search.html" id="cse-search-box">');
                document.write('  <div>');
                document.write('    <input type="hidden" name="cof" value="FORID:9">');
                document.write('    <input type="hidden" name="cx" value="003883529982892832976:e2vwumte3fq">');
                document.write('    <input type="hidden" name="ie" value="UTF-8">');
                document.write('    <input type="text" name="q" size="21">');
                document.write('    <input type="submit" name="sa" value="Search">');
                document.write('  </div>');
                document.write('</form>');
              </script>
</div></div>
<div class="trails"><div class="trail">
<a href="../../14.04" class="trail">Ubuntu 14.04</a> » <a class="trail" href="index.html" title="Ubuntu–Server-Leitfaden">Ubuntu–Server-Leitfaden</a> » <a class="trail" href="backups.html" title="Datensicherungen">Datensicherungen</a> » </div></div>
<div id="cwt-content" class="clearfix content-area"><div id="page">
<div id="content">
<div class="links nextlinks">
<a class="nextlinks-prev" href="backup-shellscripts.html" title="Shell-Skripte">Zurück</a><a class="nextlinks-next" href="bacula.html" title="Bacula">Weiter</a>
</div>
<div class="hgroup"><h1 class="title">Archiv-Rotation</h1></div>
<div class="region">
<div class="contents"><p class="para">
    The shell script in <a class="xref" href="backup-shellscripts.html" title="Shell-Skripte">Shell-Skripte</a> only allows for seven different archives.  For
    a server whose data doesn't change often, this may be enough.  If the server has a large amount of data, a more 
    complex rotation scheme should be used.
    </p></div>
<div class="links sectionlinks" role="navigation"><ul>
<li class="links"><a class="xref" href="backups-shellscripts-rotation.html#backups-nfs-rotation" title="NFS-Archive rotieren">NFS-Archive rotieren</a></li>
<li class="links"><a class="xref" href="backups-shellscripts-rotation.html#backup-shellscript-tapedrive" title="Bandlaufwerke">Bandlaufwerke</a></li>
</ul></div>
<div class="sect2 sect" id="backups-nfs-rotation"><div class="inner">
<div class="hgroup"><h2 class="title">NFS-Archive rotieren</h2></div>
<div class="region"><div class="contents">
<p class="para">
      In this section, the shell script will be slightly modified to implement a grandfather-father-son rotation scheme 
      (monthly-weekly-daily): 
      </p>
<div class="list itemizedlist"><ul class="list itemizedlist">
<li class="list itemizedlist">
          <p class="para">Die Rotation führt eine <span class="em emphasis">tägliche</span> Datensicherung von Sonntag bis Freitag durch.</p>
        </li>
<li class="list itemizedlist">
          <p class="para">Am Samstag wird eine <span class="em emphasis">wöchentliche</span> Datensicherung durchgeführt, welche vier wöchentliche Datensicherungen pro Monat erstellt.</p>
        </li>
<li class="list itemizedlist">
          <p class="para">Die <span class="em emphasis">monatliche</span> Datensicherung wird am Ersten des Monats erstellt und lässt zwei monatliche Datensicherungen rotieren, abhängig davon ob der Monat gerade oder ungerade ist.</p>
        </li>
</ul></div>
<p class="para">Hier das neue Skript:</p>
<div class="code"><pre class="contents ">#!/bin/bash
####################################
#
# Datensicherung auf NFS-Freigabe mit
# Großvater-Vater-Sohn-Rotation.
#
####################################

# Was gesichert wird. 
backup_files="/home /var/spool/mail /etc /root /boot /opt"

# Wo es gesichert wird.
dest="/mnt/backup"

# Variablen für den Archivdateinamen einrichten.
day=$(date +%A)
hostname=$(hostname -s)

# Finde heraus, welche Woche des Monats 1-4 es ist.
day_num=$(date +%d)
if (( $day_num &lt;= 7 )); then
        week_file="$hostname-week1.tgz"
elif (( $day_num &gt; 7 &amp;&amp; $day_num &lt;= 14 )); then
        week_file="$hostname-week2.tgz"
elif (( $day_num &gt; 14 &amp;&amp; $day_num &lt;= 21 )); then
        week_file="$hostname-week3.tgz"
elif (( $day_num &gt; 21 &amp;&amp; $day_num &lt; 32 )); then
        week_file="$hostname-week4.tgz"
fi

# Finde heraus, ober der Monat gerade oder ungerade ist.
month_num=$(date +%m)
month=$(expr $month_num % 2)
if [ $month -eq 0 ]; then
        month_file="$hostname-month2.tgz"
else
        month_file="$hostname-month1.tgz"
fi

# Archivdateinamen erstellen.
if [ $day_num == 1 ]; then
	archive_file=$month_file
elif [ $day != "Saturday" ]; then
        archive_file="$hostname-$day.tgz"
else 
	archive_file=$week_file
fi

# Die Start-Statusmeldung ausgeben.
echo "Sichere $backup_files nach $dest/$archive_file"
date
echo

# Die Dateien mit tar sichern.
tar czf $dest/$archive_file $backup_files

# Die Ende-Statusmeldung ausgeben.
echo
echo "Datensicherung erfolgreich"
date

#Lange Liste der Dateien in $dest um Dateigröße zu kontrollieren.
ls -lh $dest/
</pre></div>
<p class="para">Das Skript kann auf die gleiche Art wie das in <a class="xref" href="backup-shellscripts.html#backup-executing-shellscript" title="Das Skript ausführen">Das Skript ausführen</a> ausgeführt werden.</p>
<p class="para"> 
      It is good practice to take backup media off-site in case of a disaster.  In the shell script example the backup 
      media is another server providing an NFS share.  In all likelihood taking the NFS server to another location would not
      be practical.  
      Depending upon connection speeds it may be an option to copy the archive file over a WAN link to a server in another location.
      </p>
<p class="para"> 
      Another option is to copy the archive file to an external hard drive which can then be taken off-site.  
      Since the price of external hard drives continue to decrease, it may be cost-effective to use two drives for each archive level.  
      This would allow you to have one external drive attached to the backup server and one in another location.
      </p>
</div></div>
</div></div>
<div class="sect2 sect" id="backup-shellscript-tapedrive"><div class="inner">
<div class="hgroup"><h2 class="title">Bandlaufwerke</h2></div>
<div class="region"><div class="contents">
<p class="para"> 
      A tape drive attached to the server can be used instead of an NFS share.  Using a tape drive simplifies archive rotation, and
      makes taking the media off-site easier as well.  
      </p>
<p class="para"> 
      When using a tape drive, the filename portions of the script aren't needed because the data is sent directly to the tape device.
      Some commands to manipulate the tape are needed.  This is accomplished using <span class="app application">mt</span>, a magnetic tape
      control utility part of the <span class="app application">cpio</span> package.
      </p>
<p class="para">Hier das für die Benutzung von Bandlaufwerken veränderte Shell-Skript:</p>
<div class="code"><pre class="contents ">#!/bin/bash
####################################
#
# Skript für Datensicherung auf ein Bandlaufwerk.
#
####################################

# Was wird gesichert. 
backup_files="/home /var/spool/mail /etc /root /boot /opt"

# Wohin wird gesichert.
dest="/dev/st0"

# Gebe Start-Statusmeldung aus.
echo "Sichere $backup_files nach $dest"
date
echo

# Stelle sicher, dass das Band zurückgespult ist.
mt -f $dest rewind

# Sichere die Dateien mit tar.
tar czf $dest $backup_files

# Spule das Band zurück und werfe es aus.
mt -f $dest rewoffl

# Gebe Ende-Statusmeldung aus.
echo
echo "Datensicherung erfolgreich"
date
</pre></div>
<div class="note" title="Anmerkung"><div class="inner"><div class="region"><div class="contents">
        <p class="para">Der standardmäßige Gerätename eines SCSI-Bandlaufwerkes ist <span class="file filename">/dev/st0</span>. Benutzen Sie den auf Ihrem System gültigen Gerätenamen.</p>
      </div></div></div></div>
<p class="para">Das Wiederherstellen von einem Bandlaufwerk ist im Grunde genommen das Gleiche, wie das Wiederherstellen aus einer Datei. Spulen Sie das Band einfach zurück und benutzen Sie den Gerätepfad anstelle des Dateipfades. Ein Beispiel, um die Datei <span class="file filename">/etc/hosts</span> nach <span class="file filename">/tmp/etc/hosts</span> wiederherzustellen:</p>
<div class="screen"><pre class="contents "><span class="cmd command">mt -f /dev/st0 rewind</span>
<span class="cmd command">tar -xzf /dev/st0 -C /tmp etc/hosts</span>
</pre></div>
</div></div>
</div></div>
</div>
<div class="links nextlinks">
<a class="nextlinks-prev" href="backup-shellscripts.html" title="Shell-Skripte">Zurück</a><a class="nextlinks-next" href="bacula.html" title="Bacula">Weiter</a>
</div>
<div class="clear"></div>
</div>
<div id="pagebottom"></div>
</div></div>
</div>
<div id="footer"><p>The material in this document is available under a free license, see <a href="../../legal.html">Legal</a> for details.<br>
          For information on contributing see the <a href="https://wiki.ubuntu.com/DocumentationTeam">Ubuntu Documentation Team wiki page</a>.
          To report errors in this serverguide documentation, <a href="https://bugs.launchpad.net/serverguide">file a bug report</a>.</p></div>
</div>
</body>
</html>
