<!DOCTYPE html>
<html lang=zh-CN>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Securing File and Print Server</title>
<link rel="stylesheet" type="text/css" href="zh_CN.css">
<script type="text/javascript" src="jquery.js"></script><script type="text/javascript" src="jquery.syntax.js"></script><script type="text/javascript" src="yelp.js"></script>
</head>
<body id="home">
<script src="https://ssl.google-analytics.com/urchin.js" type="text/javascript"></script><script type="text/javascript">
        _uacct = "UA-1018242-8";
        urchinTracker();
      </script><div id="container">
<div id="container-inner">
<div id="mothership"><ul>
<li><a href="https://partners.ubuntu.com">Partners</a></li>
<li><a href="https://www.ubuntu.com/support/community-support">Support</a></li>
<li><a href="https://community.ubuntu.com">Community</a></li>
<li><a href="https://www.ubuntu.com">Ubuntu.com</a></li>
</ul></div>
<div id="header">
<h1 id="ubuntu-header"><a href="https://help.ubuntu.com/">Ubuntu Documentation</a></h1>
<ul id="main-menu">
<li><a class="main-menu-item current" href="../../">Official Documentation</a></li>
<li><a href="https://help.ubuntu.com/community/CommunityHelpWiki">Community Help Wiki</a></li>
<li><a href="https://community.ubuntu.com/t/contribute/26">Contribute</a></li>
</ul>
</div>
<div id="menu-search"><div id="search-box">
<noscript><form action="https://www.google.com/cse" id="cse-search-box"><div>
<input type="hidden" name="cx" value="003883529982892832976:e2vwumte3fq"><input type="hidden" name="ie" value="UTF-8"><input type="text" name="q" size="21"><input type="submit" name="sa" value="Search">
</div></form></noscript>
<script>
                document.write('<form action="../../search.html" id="cse-search-box">');
                document.write('  <div>');
                document.write('    <input type="hidden" name="cof" value="FORID:9">');
                document.write('    <input type="hidden" name="cx" value="003883529982892832976:e2vwumte3fq">');
                document.write('    <input type="hidden" name="ie" value="UTF-8">');
                document.write('    <input type="text" name="q" size="21">');
                document.write('    <input type="submit" name="sa" value="Search">');
                document.write('  </div>');
                document.write('</form>');
              </script>
</div></div>
<div class="trails"><div class="trail">
<a href="../../14.04" class="trail">Ubuntu 14.04</a> » <a class="trail" href="index.html" title="Ubuntu 服务器指南">Ubuntu 服务器指南</a> » <a class="trail" href="samba.html" title="Samba">Samba</a> » </div></div>
<div id="cwt-content" class="clearfix content-area"><div id="page">
<div id="content">
<div class="links nextlinks">
<a class="nextlinks-prev" href="samba-printserver.html" title="打印服务器">上一页</a><a class="nextlinks-next" href="samba-dc.html" title="As a Domain Controller">下一页</a>
</div>
<div class="hgroup"><h1 class="title">Securing File and Print Server</h1></div>
<div class="region">
<div class="contents"></div>
<div class="links sectionlinks" role="navigation"><ul>
<li class="links"><a class="xref" href="samba-fileprint-security.html#samba-security-mode" title="Samba安全模式">Samba安全模式</a></li>
<li class="links"><a class="xref" href="samba-fileprint-security.html#samba-user-security" title="Security = User">Security = User</a></li>
<li class="links"><a class="xref" href="samba-fileprint-security.html#samba-share-security" title="共享安全">共享安全</a></li>
<li class="links"><a class="xref" href="samba-fileprint-security.html#samba-apparmor" title="Samba AppArmor 策略">Samba AppArmor 策略</a></li>
<li class="links"><a class="xref" href="samba-fileprint-security.html#samba-security-resources" title="资源">资源</a></li>
</ul></div>
<div class="sect2 sect" id="samba-security-mode"><div class="inner">
<div class="hgroup"><h2 class="title">Samba安全模式</h2></div>
<div class="region"><div class="contents">
<p class="para">有2种安全等级支持通用网络文件系统协议(CIFS), <span class="em emphasis">user-等级</span> 和 <span class="em emphasis">share-等级</span> Samba的 <span class="em emphasis">security 模式</span> 允许更灵活的执行方式，为user-level安全等级提供了4种方式，为share-level等级提供了一种方式。</p>
<div class="list itemizedlist"><ul class="list itemizedlist">
<li class="list itemizedlist">
          <p class="para">设置为 <span class="em emphasis">security = user:</span> 就需要连接共享的客户机提供用户名和密码。虽然Samba的用户帐户区别于系统帐户，但是软件包 <span class="app application">libpam-smbpass</span> 会同步系统用户名和密码与Samba用户数据库。</p>
        </li>
<li class="list itemizedlist">
          <p class="para"><span class="em emphasis">security = domain:</span> 这个模式使得Samba 服务器作为 一个Windows 客户端的主域控制器 ( PDC ) , 备份域控制器(BDC) ,或者一个域成员服务器(DMS) ,了解更多信息参见 <a class="xref" href="samba-dc.html" title="As a Domain Controller">As a Domain Controller</a>。</p>
        </li>
<li class="list itemizedlist">
          <p class="para"><span class="em emphasis">security = ADS:</span> 允许 Samba服务器作为一个本地成员加入活动目录域。详细内容参见 <a class="xref" href="samba-ad-integration.html" title="Active Directory Integration">Active Directory Integration</a></p>
        </li>
<li class="list itemizedlist">
          <p class="para"><span class="em emphasis">security = server:</span> 这种模式是Samba作为一个成员服务器之前设置的。由于一些安全问题不应该使用。想了解更多信息，请查看 Samba 指南中<a href="http://samba.org/samba/docs/man/Samba-HOWTO-Collection%20/ServerType.html#id349531" class="ulink" title="http://samba.org/samba/docs/man/Samba-HOWTO-Collection /ServerType.html#id349531">Server Security</a></p>
        </li>
<li class="list itemizedlist">
          <p class="para">参数 <span class="em emphasis">security = share:</span> 允许客户机访问共享文件时不提供用户名和密码。</p>
        </li>
</ul></div>
<p class="para">您将选择的安全模式将取决与您的环境和您需要用Samba服务器完成的工作。</p>
</div></div>
</div></div>
<div class="sect2 sect" id="samba-user-security"><div class="inner">
<div class="hgroup"><h2 class="title">Security = User</h2></div>
<div class="region"><div class="contents">
<p class="para">本节将根据 <a class="xref" href="samba-fileserver.html" title="File Server">File Server</a> 和 <a class="xref" href="samba-printserver.html" title="打印服务器">打印服务器</a>重新配置 Samba 文件和打印服务器。</p>
<p class="para">首先安装软件包 <span class="app application">libpam-smbpass</span> 同步系统用户与 Samba 用户数据库：</p>
<div class="screen"><pre class="contents "><span class="cmd command">sudo apt-get install libpam-smbpass</span>
</pre></div>
<div class="note" title="备注"><div class="inner"><div class="region"><div class="contents">
        <p class="para">如果你在安装过程中选择 <span class="em emphasis">Samba Server</span> 任务则软件包 <span class="app application">libpam-smbpass</span> 就已经安装在系统中。</p>
      </div></div></div></div>
<p class="para">编辑<span class="file filename">/etc/samba/smb.conf</span>，并且在<span class="em emphasis">[share]</span>区域更改：</p>
<div class="code"><pre class="contents ">    来宾就绪=no
</pre></div>
<p class="para">最后，为使得新设定生效，请重启Samba</p>
<div class="screen"><pre class="contents "><span class="cmd command">sudo restart smbd</span>
<span class="cmd command">sudo restart nmbd</span>
</pre></div>
<p class="para">当连接到共享的目录或打印机时，您需要一个用户名和密码。</p>
<div class="note" title="备注"><div class="inner"><div class="region"><div class="contents">
        <p class="para">如果你选择要映射一个网络驱动器，那么你可以选择<span class="quote">“Reconnect at Logon”</span> 复选框，并且只需输入一次用户名和密码。至少在密码不变的情况下。</p>
      </div></div></div></div>
</div></div>
</div></div>
<div class="sect2 sect" id="samba-share-security"><div class="inner">
<div class="hgroup"><h2 class="title">共享安全</h2></div>
<div class="region">
<div class="contents"><p class="para">有几个选项可以为每个共享目录增强安全性。以 <span class="em emphasis">[share]</span> 为例，这节中包括了一些常见的选项。</p></div>
<div class="sect3 sect" id="windows-networking-groups"><div class="inner">
<div class="hgroup"><h3 class="title">组</h3></div>
<div class="region"><div class="contents">
<p class="para">组定义了对指定网络资源拥有共同访问级别的一组计算机或用户，并提供对这些资源的访问控制粒度级别。举个例子，如果定义一个 <span class="em emphasis">qa</span> 组并包含用户 <span class="em emphasis">freda</span>、<span class="em emphasis">danika</span> 和 <span class="em emphasis">rob</span>，再定义第二个组 <span class="em emphasis">support</span> 并包含 <span class="em emphasis">danika</span>、<span class="em emphasis">jeremy</span> 和 <span class="em emphasis">vincent</span>。那么某个网络资源被配置为允许 <span class="em emphasis">qa</span> 组访问时，则其可以被 freda、danika 和 rob访问，而不是 jeremy 或 vincent。因为用户 <span class="em emphasis">danika</span> 属于 <span class="em emphasis">qa</span> 和 <span class="em emphasis">support</span> 两个组，所以她能够访问配置为两个组访问的资源，而所有其他用户则只能访问明确允许其所属组访问的资源。</p>
<p class="para">默认的 Samba 会查找本地系统组文件 <span class="file filename">/etc/group</span> 以确定哪些用户属于哪些用户组。欲了解更多有关添加和删除用户组请访问 <a class="xref" href="user-management.html#adding-deleting-users" title="添加和删除用户">添加和删除用户</a>.</p>
<p class="para">在Samba 设置文件 <span class="file filename">/etc/samba/smb.conf</span> 中定义了组以后，公认的语法是以“ @ ”符号作为组名的开始。例如，如果你想定义一个组名 <span class="em emphasis">sysadmin</span> 你就需要在文件 <span class="file filename">/etc/samba/smb.conf</span>中相关的章节下输入组的名字比如 <span class="em em-bold emphasis">@sysadmin</span>。</p>
</div></div>
</div></div>
<div class="sect3 sect" id="samba-file-permissions"><div class="inner">
<div class="hgroup"><h3 class="title">文件权限</h3></div>
<div class="region"><div class="contents">
<p class="para">文件权限清楚的表明了计算机或者用户对特定目录所拥有的权力。这种权限的定义可以通过编辑文件 <span class="file filename">/etc/samba/smb.conf</span>来确定一个共享文件的权限。</p>
<p class="para">例如：如果你定义一个Samba的共享，命名为 <span class="em emphasis">share</span>并且给予用户组<span class="em emphasis">qa</span>, <span class="em emphasis">只读</span> 的权限, 。但是希望允许一个名为 <span class="em emphasis">sysadmin</span> 的组中一个<span class="em emphasis">vincent</span> 用户可以写共享。这样的话你需要编辑文件 <span class="file filename">/etc/samba/smb.conf</span> 在<span class="em emphasis">[share]</span>下面添加：</p>
<div class="code"><pre class="contents ">    read list = @qa
    write list = @sysadmin, vincent
</pre></div>
<p class="para">另一种可能的Samba权限是为特定的共享资源声明一个管理权限。用户拥有管理权限后可以读，写或修改资源中的任何信息。用户被给予了明确的管理权限。</p>
<p class="para">举个例子，如果你想给予用户<span class="em emphasis">melissa</span>管理权限，你可以编辑文件 <span class="file filename">/etc/samba/smb.conf</span> 在<span class="em emphasis">[share]</span> 节中添加如内容：</p>
<div class="code"><pre class="contents ">    用户名=melissa
</pre></div>
<p class="para">编辑<span class="file filename">/etc/samba/smb.conf</span>以后请重启Samba使更改生效：</p>
<div class="screen"><pre class="contents "><span class="cmd command">sudo restart smbd</span>
<span class="cmd command">sudo restart nmbd</span>
</pre></div>
<div class="note" title="备注"><div class="inner"><div class="region"><div class="contents">
          <p class="para">要想<span class="em emphasis">read list</span>和<span class="em emphasis">write list</span>可以工作，Samba安全模式决不能设置成<span class="em emphasis">security = share</span></p>
        </div></div></div></div>
<p class="para">Samba 已经配置为限定某些组对共享目录的访问，文件系统权限需要更新。</p>
<p class="para">传统 Linux 文件权限没有很好地映射到 Windows NT 访问控制表(ACLs)，然而，Ubuntu 服务器可以使用 POSIX ACLs 以提供更细粒度的控制。例如，想要在 EXT3 文件系统中使用 ACLs <span class="file filename">/srv</span>，只需编辑文件 <span class="file filename">/etc/fstab</span>，添加 <span class="em emphasis">acl</span> 选项：</p>
<div class="code"><pre class="contents ">UUID=66bcdd2e-8861-4fb0-b7e4-e61c569fe17d /srv  ext3    noatime,relatime,acl 0       1
</pre></div>
<p class="para">然后重新挂载分区：</p>
<div class="screen"><pre class="contents "><span class="cmd command">sudo mount -v -o remount /srv</span>
</pre></div>
<div class="note" title="备注"><div class="inner"><div class="region"><div class="contents">
          <p class="para">以上示例假设 <span class="file filename">/srv</span> 在单独的分区。无论您配置的共享目录 <span class="file filename">/srv</span> 在什么位置，只要它属于 <span class="file filename">/</span> 分区，都可能需要重启。</p>
        </div></div></div></div>
<p class="para">为完成以上 Samba 设置，针对共享目录 <span class="file filename">/srv/samba/share</span>，<span class="em emphasis">sysadmin</span> 组需要给出读、写、执行的权限，而 <span class="em emphasis">qa</span> 需要给出读与执行的权限，并且其文件应隶属于用户 <span class="em emphasis">melissa</span>。在终端中输入：</p>
<div class="screen"><pre class="contents "><span class="cmd command">sudo chown -R melissa /srv/samba/share/</span>
<span class="cmd command">sudo chgrp -R sysadmin /srv/samba/share/</span>
<span class="cmd command">sudo setfacl -R -m g:qa:rx /srv/samba/share/</span>
</pre></div>
<div class="note" title="备注"><div class="inner"><div class="region"><div class="contents">
          <p class="para">如上命令 <span class="app application">setfacl</span> 会将目录 <span class="file filename">/srv/samba/share</span> 下所有文件给予 <span class="em emphasis">执行</span> 的权限，这可能并不是您所希望的。</p>
        </div></div></div></div>
<p class="para">现在，通过使用Windows客户端，你应该注意到新的文件的权限开始应用了。想了解更多关于POSIX ACLs的信息请使用 man 命令查看 <span class="app application">acl</span> 和 <span class="app application">setfacl</span>程序的帮助文档。</p>
</div></div>
</div></div>
</div>
</div></div>
<div class="sect2 sect" id="samba-apparmor"><div class="inner">
<div class="hgroup"><h2 class="title">Samba AppArmor 策略</h2></div>
<div class="region"><div class="contents">
<p class="para">Ubuntu 带有 <span class="app application">AppArmor</span> 安全模块，提供必须的访问控制功能。为符合您的配置，需要对默认的 Samba AppArmor 策略做些修改。详情使用 AppArmor，请参考 <a class="xref" href="apparmor.html" title="AppArmor">AppArmor</a>。</p>
<p class="para"><span class="file filename">/usr/sbin/smbd</span> 和 <span class="file filename">/usr/sbin/nmbd</span> 是 Samba 守护进程的两个程序，它们默认的 AppArmor 策略，包含在 <span class="app application">apparmor-profiles</span> 软件包，要安装这个包，在终端命令行中输入：</p>
<div class="screen"><pre class="contents "><span class="cmd command">sudo apt-get install apparmor-profiles apparmor-utils</span>
</pre></div>
<div class="note" title="备注"><div class="inner"><div class="region"><div class="contents">
        <p class="para">这个软件包还带有其它一些程序的策略。</p>
      </div></div></div></div>
<p class="para">默认情况下，<span class="app application">smbd</span> 和 <span class="app application">nmbd</span> 工作在 <span class="em emphasis">complain</span> 的策略模式，即无需修改默认的策略，Samba 就能工作，但在这种模式下，仅仅会记录错误到日志。 要让 <span class="app application">smbd</span> 切换到 <span class="em emphasis">enforce</span> 的策略模式，以使得 Samba 如期望地工作，则默认的策略需要进行修改，以反映到每一个共享的目录。</p>
<p class="para">例如，在文件服务器上添加 <span class="em emphasis">[share]</span> 的标识信息，编辑 <span class="file filename">/etc/apparmor.d/usr.sbin.smbd</span>：</p>
<div class="code"><pre class="contents ">  /srv/samba/share/ r,
  /srv/samba/share/** rwkix,
</pre></div>
<p class="para">切换到 <span class="em emphasis">enforce</span> 的策略模式，并重新加载：</p>
<div class="screen"><pre class="contents "><span class="cmd command">sudo aa-enforce /usr/sbin/smbd</span>
<span class="cmd command">cat /etc/apparmor.d/usr.sbin.smbd | sudo apparmor_parser -r</span>
</pre></div>
<p class="para">您现在可以正常地读取、写入和执行共享目录中的文件，<span class="app application">smbd</span> 程序将仅会访问配置文件和目录。请确定添加要让 Samba 共享的每个目录。同时，任何的错误会被记录在 <span class="file filename">/var/log/syslog</span>。</p>
</div></div>
</div></div>
<div class="sect2 sect" id="samba-security-resources"><div class="inner">
<div class="hgroup"><h2 class="title">资源</h2></div>
<div class="region"><div class="contents"><div class="list itemizedlist"><ul class="list itemizedlist">
<li class="list itemizedlist">
          <p class="para">要更深入地了解Samba设定请参阅<a href="http://samba.org/samba/docs/man/Samba-HOWTO-Collection/" class="ulink" title="http://samba.org/samba/docs/man/Samba-HOWTO-Collection/">Samba HOWTO Collection</a></p>
        </li>
<li class="list itemizedlist">
          <p class="para">您也可以在<a href="http://www.amazon.com/exec/obidos/tg/detail/-/0131882228" class="ulink" title="http://www.amazon.com/exec/obidos/tg/detail/-/0131882228">printed format</a>查看帮助</p>
        </li>
<li class="list itemizedlist">
          <p class="para">O'Reilly的<a href="http://www.oreilly.com/catalog/9780596007690/" class="ulink" title="http://www.oreilly.com/catalog/9780596007690/">使用Samba</a>也是一本不错的参考书。</p>
        </li>
<li class="list itemizedlist">
          <p class="para">Samba HOWTO集锦的<a href="http://samba.org/samba/docs/man/Samba-HOWTO-Collection/securing-samba.html" class="ulink" title="http://samba.org/samba/docs/man/Samba-HOWTO-Collection/securing-samba.html">第18章</a>主要致力于安全问题。</p>
        </li>
<li class="list itemizedlist">
          <p class="para">有关Samba和ACL的更多信息请参看<a href="http://samba.org/samba/docs/man/Samba-HOWTO-Collection/AccessControls.html#id397568" class="ulink" title="http://samba.org/samba/docs/man/Samba-HOWTO-Collection/AccessControls.html#id397568">Samba ACLs页面</a>。</p>
        </li>
<li class="list itemizedlist">
          <p class="para">
          The <a href="https://help.ubuntu.com/community/Samba" class="ulink" title="https://help.ubuntu.com/community/Samba">Ubuntu Wiki Samba </a> page.
          </p>
        </li>
</ul></div></div></div>
</div></div>
</div>
<div class="links nextlinks">
<a class="nextlinks-prev" href="samba-printserver.html" title="打印服务器">上一页</a><a class="nextlinks-next" href="samba-dc.html" title="As a Domain Controller">下一页</a>
</div>
<div class="clear"></div>
</div>
<div id="pagebottom"></div>
</div></div>
</div>
<div id="footer"><p>The material in this document is available under a free license, see <a href="../../legal.html">Legal</a> for details.<br>
          For information on contributing see the <a href="https://wiki.ubuntu.com/DocumentationTeam">Ubuntu Documentation Team wiki page</a>.
          To report errors in this serverguide documentation, <a href="https://bugs.launchpad.net/serverguide">file a bug report</a>.</p></div>
</div>
</body>
</html>
